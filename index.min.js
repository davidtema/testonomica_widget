const EVENT_FINISH="finish",EVENT_RESIZE="resize",EVENT_LOADED="loaded",langDetect=function(){const t=void 0===navigator.languages?[navigator.language]:navigator.languages;if(!t)return"ru";return t[0].split(/[-_]/)[0]},randString=function(t){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n=e.length;let i="";for(let a=0;a<t;a++)i+=e.charAt(Math.floor(Math.random()*n));return i};function boolParam(t,e){return null===t?e:"1"===t||1===t||!0===t||"true"===t?1:0}function stingParam(t,e){return null===t?e:t}function configure(t){const e=t.getAttribute("data-test");if(!e)throw new Error('Error no test specified (e.g data-test="102").');const n=t.getAttribute("data-token"),i=boolParam(t.getAttribute("data-show-result-after-load"),1),a=boolParam(t.getAttribute("data-display-report"),1),o=stingParam(t.getAttribute("data-init"),"auto",["auto"]);if(-1===["auto","manual"].indexOf(o))throw new Error("Unsupported value init: "+o);let s=stingParam(t.getAttribute("data-lang"),"auto",["ru","en"]);return"auto"===s&&(s=langDetect()),{host:t.getAttribute("data-host")??"https://testonomica.com",lang:s,testId:e,token:n,displayReport:a,showResultAfterLoad:i,init:o}}class TncEventDispatcher{constructor(){this.listeners={}}addEventListener(t,e){this.listeners.hasOwnProperty(t)||(this.listeners[t]=[]),this.listeners[t].push(e)}dispatchEvent(t){if(this.listeners[t.type])for(let e in this.listeners[t.type])this.listeners[t.type][e](t.detail)}}const session=function(){const t="tnc_sid";function e(){return localStorage.getItem(t)}return e()||localStorage.setItem(t,randString(12)),e()};class Widget{constructor(t,e,n){this._block=t,this.config=e,this.dispatcher=n}init(){log("init widget");const t=this.config,e={token:t.token,displayReport:t.displayReport,showResultAfterLoad:t.showResultAfterLoad,sid:session()},n=document.createElement("div");n.innerHTML=this._block.innerHTML,this._block.after(n),this._block.innerHTML="";const i="ru"!==t.lang?`/${t.lang}`:"";log("lang: "+i);const a=`${t.host}${i}/tests/w/${t.testId}/?${new URLSearchParams(e).toString()}`;log("Iframe url: "+a);const o=document.createElement("iframe");o.src=a,o.scrolling="no",o.style.border="none",o.style.height="auto",o.style.width="100%",o.style.display="none",this._block.appendChild(o),log("Iframe added: "+(1===this._block.getElementsByTagName("iframe").length?"yes":"no")),this.dispatcher.addEventListener("loaded",(function(t){log("Iframe event handle: loaded"),n.remove(),o.style.display="block"})),this.dispatcher.addEventListener("resize",(function(t){log("Iframe event handle: resize");const e=parseInt(t.frameHeight);o.style.height=e+"px"}))}addEventListener(t,e){this.dispatcher.addEventListener(t,e)}}const dispatcher=new TncEventDispatcher,log=function(...t){dispatcher.dispatchEvent(new CustomEvent("log",{detail:{msg:t}}))},block=document.getElementById("testonomica_app");if(!block)throw log("No tag found."),new Error('Error tag id "testonomica_app" not found.');const config=configure(block);window.addEventListener("message",(function(t){if(log("Window.onmessage from "+t.origin),t.origin===config.host&&t.data.hasOwnProperty("name")){log(t.data.name);const e=t.data.name;"frameHeight"===e?dispatcher.dispatchEvent(new CustomEvent("resize",{detail:{frameHeight:t.data.frameHeight}})):"finish"===e?dispatcher.dispatchEvent(new CustomEvent("finish",{detail:{key:t.data.key}})):"loaded"===e&&dispatcher.dispatchEvent(new CustomEvent("loaded"))}}));const tncw=new Widget(block,config,dispatcher);"auto"===config.init&&tncw.init(),window.tncw=tncw;
